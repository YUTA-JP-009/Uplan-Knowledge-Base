# extracted_at フィールドの日本時間（JST）対応

## 変更概要
`extracted_at`フィールドを日本時間（JST）で保存するように変更しました。

## 変更日時
2026-01-09

## 変更理由
- ユーザーが日本在住であり、日本時間での表示が望ましい
- データの可読性向上
- タイムゾーン情報を明示的に保存

---

## 変更内容

### Before（変更前）
```python
"extracted_at": firestore.SERVER_TIMESTAMP  # UTCで保存されていた
```

### After（変更後）
```python
from datetime import datetime, timezone, timedelta

# 日本時間のタイムゾーン
JST = timezone(timedelta(hours=9))

"extracted_at": datetime.now(JST).isoformat()  # JSTで保存
```

---

## 変更されたファイル

### 1. batch_processor_v4_rate_optimized.py（本番環境用・推奨）
- **行数**: 27-31行目（インポート追加）
- **行数**: 522行目（extracted_at変更）
- **変更内容**:
  ```python
  # 変更前
  "extracted_at": firestore.SERVER_TIMESTAMP,

  # 変更後
  "extracted_at": datetime.now(JST).isoformat(),
  ```

### 2. batch_processor_v3_parallel.py（並列処理版）
- **行数**: 25-28行目（インポート追加）
- **行数**: 586行目（extracted_at変更）

### 3. batch_processor_v3.py（基本版）
- **行数**: 9-12行目（インポート追加）
- **行数**: 732行目（extracted_at変更）
- **行数**: 731行目（processed_at変更）※このファイルのみ

### 4. test_5_projects_detailed.py（テスト用）
- **行数**: 17-21行目（インポート追加）
- **行数**: 390行目（extracted_at変更）

### 5. CLAUDE.md（ドキュメント）
- **行数**: 95行目（説明文変更）
- **変更内容**:
  ```markdown
  # 変更前
  - `extracted_at`: データの抽出日時（Firestore Timestamp）

  # 変更後
  - `extracted_at`: データの抽出日時（ISO 8601形式、日本時間JST）
  ```

---

## データ形式

### ISO 8601形式（タイムゾーン情報付き）
```
2026-01-09T22:03:41.853454+09:00
```

### 形式の説明
- `2026-01-09`: 日付（YYYY-MM-DD）
- `T`: 日付と時刻の区切り
- `22:03:41.853454`: 時刻（HH:MM:SS.マイクロ秒）
- `+09:00`: タイムゾーンオフセット（日本時間 = UTC+9時間）

---

## メリット

### 1. 可読性の向上
- ユーザーがデータを見たときに、すぐに日本時間であることがわかる
- タイムゾーン変換の必要がない

### 2. タイムゾーン情報の明示
- ISO 8601形式には`+09:00`というオフセット情報が含まれる
- どのタイムゾーンで記録されたかが明確

### 3. データの一貫性
- すべてのデータが同じタイムゾーン（JST）で記録される
- 時系列分析が容易

---

## 互換性

### Firestoreでの表示
- Firestoreコンソールでは文字列として表示されます
- タイムスタンプ型ではなく、String型として保存されます

### クエリへの影響
- 文字列比較でも日付順序が保たれます（ISO 8601の特性）
- 範囲検索も可能:
  ```python
  # 2026年1月9日以降のデータを取得
  docs = collection.where("extracted_at", ">=", "2026-01-09T00:00:00+09:00").stream()
  ```

### 既存データへの影響
- **後方互換性**: 既存のデータ（SERVER_TIMESTAMP形式）はそのまま残ります
- **混在可能**: 古いデータと新しいデータが混在しても問題ありません
- **変換不要**: 既存データの変換は不要です

---

## 動作確認

### テストスクリプト
[test_jst_timestamp.py](test_jst_timestamp.py)を実行して動作確認済み

```bash
./venv/bin/python3 test_jst_timestamp.py
```

### 確認結果
```
現在のJST時刻: 2026-01-09 22:03:41.853454+09:00
ISO 8601形式: 2026-01-09T22:03:41.853454+09:00
タイムゾーン: UTC+09:00
UTCオフセット: +0900
```

✅ 日本時間で正しく保存されることを確認

---

## 今後の対応

### すぐに実施
- [x] 全バッチプロセッサーの修正
- [x] ドキュメントの更新
- [x] 動作確認テスト

### 今後検討
- [ ] フロントエンドでの日本時間表示対応
- [ ] タイムゾーン変換ユーティリティ関数の作成（必要に応じて）
- [ ] 既存データの一括変換（必要に応じて）

---

## 注意事項

1. **デプロイ時**: 変更後のコードをCloud Run Jobsにデプロイする必要があります
   ```bash
   ./deploy.sh
   ```

2. **混在期間**: デプロイ前のデータはUTC、デプロイ後はJSTで保存されます
   - データ分析時にタイムゾーンを確認してください

3. **サマータイム**: 日本にはサマータイムがないため、常に`+09:00`です

---

## 参考情報

### ISO 8601形式について
- 国際標準のタイムスタンプ形式
- タイムゾーン情報を含む
- 文字列ソートで時系列順序が保たれる

### Pythonでの実装
```python
from datetime import datetime, timezone, timedelta

# 日本時間のタイムゾーン定義
JST = timezone(timedelta(hours=9))

# 現在時刻をJSTで取得
now_jst = datetime.now(JST)

# ISO 8601形式の文字列に変換
timestamp_str = now_jst.isoformat()
# 例: "2026-01-09T22:03:41.853454+09:00"
```

---

## まとめ

✅ 全てのバッチプロセッサーでextracted_atが日本時間（JST）で保存されるようになりました
✅ タイムゾーン情報が明示的に含まれるため、混乱を防ぐことができます
✅ ISO 8601形式により、国際標準に準拠したデータ形式になりました
✅ 既存データとの互換性も保たれています
