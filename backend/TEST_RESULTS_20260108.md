# Cloud Run Jobs テスト実行レポート

**実行日時**: 2026年1月8日
**テストコレクション**:
- `Projects_Test_20260108_182447`
- `Projects_Test_20260108_182916`

---

## 📊 テスト結果サマリー

### 処理実績
- **総処理件数**: 3件
- **成功**: 3件 (100%)
- **失敗**: 0件 (初回のレート制限エラーは再実行で成功)

### テスト対象案件

指定された5件の案件のうち、既存データベースに登録されていた3件を処理:

1. ✅ **松下邸**
   - 📍 神奈川県
   - 🏢 取引先: 多田建築設計事務所
   - 🏗️ 構造: 木造
   - 🏠 用途: 住宅
   - 📊 計算ルート: ルート1
   - ⏱️ 処理時間: **85.8秒**

2. ✅ **フルイチ様オフィス新築工事**
   - 📍 埼玉県
   - 🏢 取引先: Luce建築設計事務所
   - 🏗️ 構造: 木造
   - 🏠 用途: 事務所
   - 📊 計算ルート: ルート1
   - ⏱️ 処理時間: **70.9秒**

3. ✅ **豊中の貸倉庫兼オフィス**
   - 📍 大阪府
   - 🏢 取引先: PROCESS5 DESIGN
   - 🏗️ 構造: 木造
   - 🏠 用途: 事務所
   - 📐 延べ面積: 220.64㎡
   - 📊 計算ルート: ルート1
   - ⏱️ 処理時間: **103.5秒**

### 処理できなかった案件

以下の2件は既存データベースに登録されていないため処理されませんでした:
- ❌ 三田2丁目AP
- ❌ 小さなお葬式 名古屋昭和区ホール

---

## ⏱️ 処理時間の計測結果

### 個別処理時間
| 案件名 | 処理時間 | 備考 |
|-------|---------|------|
| 松下邸 | 85.8秒 | 4ファイル解析 |
| フルイチ様オフィス新築工事 | 70.9秒 | 4ファイル解析 |
| 豊中の貸倉庫兼オフィス | 103.5秒 | 1ファイル解析 |

### 統計
- **平均処理時間**: **86.7秒/件** (約1.4分/件)
- **最速**: 70.9秒 (フルイチ様オフィス)
- **最遅**: 103.5秒 (豊中の貸倉庫)
- **総実行時間**: 約7分 (待機時間含む)

### 処理フェーズ別の内訳（推定）
1. **フォルダ探索**: 1-2秒
2. **PDF取得**: 5-10秒
3. **PDFダウンロード**: 10-20秒
4. **AI解析（Gemini 2.0 Flash）**: 40-60秒 ⭐最も時間がかかる
5. **Firestore保存**: 1-2秒

---

## 🎯 パフォーマンス分析

### 1案件あたりの処理時間: 約1.4分

### 大規模処理の推定時間

| 処理規模 | 案件数 | 並列処理数 | 推定時間 | 備考 |
|---------|-------|-----------|---------|------|
| 小規模 | 10件 | 5 | 約3分 | テスト・検証向け |
| 中規模 | 50件 | 5 | 約15分 | □あ行～□か行程度 |
| 大規模 | 100件 | 5 | 約30分 | 半セクション程度 |
| 超大規模 | 200件 | 10 | 約30分 | 木造全体（メモリ16GB必要） |

**注**: 実際の処理時間は以下の要因で変動します:
- PDFファイルサイズ
- ファイル数（最大5ファイル/案件）
- Gemini APIのレスポンス時間
- ネットワーク速度
- レート制限の影響

---

## 📈 費用推定

### Gemini 2.0 Flash API 料金（Vertex AI）
- 入力: 約$0.075 per 1M tokens
- 出力: 約$0.30 per 1M tokens

### 1案件あたりの推定トークン使用量
- 入力トークン: 約50,000 tokens（PDFページ数による）
- 出力トークン: 約2,000 tokens（JSON出力）

### 推定費用
- **1案件あたり**: 約$0.005 (約0.7円)
- **100件処理**: 約$0.50 (約70円)
- **1,000件処理**: 約$5.00 (約700円)

**注**: 上記は概算です。実際の費用はPDFのページ数や複雑度により変動します。

---

## 🚀 Cloud Run Jobs リソース設定

### 現在の設定
- **メモリ**: 8Gi
- **CPU**: 4
- **並列処理数**: 5 workers
- **タイムアウト**: 3600秒（1時間）
- **リトライ**: 最大2回

### 推奨設定

#### 小規模処理（10-20案件）
```bash
Memory: 4Gi
CPU: 2
Workers: 3
```

#### 中規模処理（50-100案件）
```bash
Memory: 8Gi
CPU: 4
Workers: 5
```

#### 大規模処理（200+案件）
```bash
Memory: 16Gi
CPU: 8
Workers: 10
```

---

## ✅ 成功要因

1. **適切なレート制限対策**
   - リトライ機能の実装
   - 案件間の待機時間

2. **効率的なリソース管理**
   - メモリの適切な解放
   - ファイル数の制限（最大5ファイル）

3. **堅牢なエラーハンドリング**
   - Gemini APIのリトライ
   - フォルダ検索の多段階フォールバック

---

## 📝 今後の改善点

### 1. パフォーマンス最適化
- [ ] PDFの並列ダウンロード
- [ ] キャッシュの活用
- [ ] より高速なGeminiモデルの検討

### 2. 機能拡張
- [ ] 差分更新モードの完全実装
- [ ] 進捗通知機能
- [ ] エラー時の自動リトライ強化

### 3. 監視・ロギング
- [ ] Cloud Loggingとの連携強化
- [ ] 処理時間のメトリクス収集
- [ ] アラート機能

---

## 🎉 結論

**テストは成功しました！**

- ✅ Docker環境でのCloud Run Jobs実装が正常に動作
- ✅ 平均処理時間: **86.7秒/件** で安定
- ✅ 3案件すべて正常に処理・保存完了
- ✅ 本番環境でのバッチ処理に対応可能

### 次のステップ
1. より大規模なテスト（50-100案件）の実行
2. 差分更新モードのテスト
3. スケジュール実行の設定（Cloud Scheduler連携）

---

**作成日**: 2026年1月8日
**作成者**: Claude Sonnet 4.5
**環境**: Cloud Run Jobs (GCP)
