過去案件ナレッジ検索システム開発プロジェクト (U'plan Knowledge Base)
1. プロジェクト概要
構造設計事務所の過去案件データ（OneDrive上のPDF）をAIで解析・構造化し、SUUMOのように詳細な条件で検索できる社内ナレッジベースを構築するプロジェクト。

目的: 過去の設計ノウハウ（暗黙知）の形式知化、検索コストの削減、設計品質の向上。

現状: PoC（概念実証）が完了し、ローカル環境でのバッチ処理プログラム（v3）の実装フェーズ。

前提: データはGitHubに蓄積して、ホスティングはバーセルで行います。

2. システムアーキテクチャ
コード スニペット

graph TD
    subgraph "Microsoft 365 (Data Source)"
        A[OneDrive / SharePoint]
        NoteA[階層: クライアント > 物件 > 納品フォルダ]
    end

    subgraph "Processing Unit (Python)"
        B[batch_processor_v3.py]
        B1{ファイル選定ロジック}
        B2[PDFダウンロード]
        B3[AI解析 (Gemini 2.5 Pro)]
    end

    subgraph "Google Cloud Platform"
        C[Secret Manager] -->|認証情報| B
        B -->|Vertex AI API| D[Gemini 2.5 Pro]
        B -->|構造化データ| E[Firestore]
    end

    A -->|Graph API| B
3. 技術スタック & 環境
言語: Python 3.11+

認証:

Microsoft Graph API: アプリケーション権限 (Files.Read.All, Sites.Read.All)

GCP: Application Default Credentials (gcloud auth application-default login)

主要ライブラリ:

msal (Microsoft認証)

requests (APIコール)

google-cloud-secret-manager (機密情報管理)

google-cloud-firestore (DB保存)

google-cloud-aiplatform (Vertex AI)

vertexai (Gemini SDK)

4. 現在の実装状況 (batch_processor_v3.py)
4.1. 処理フロー
再帰的フォルダ探索:

指定されたルートパス (001_Ｕ'plan_全社/01.構造設計/...) から探索を開始。

フォルダ名に「納品」または「成果物」が含まれる場合のみ処理対象とする。

ベストファイル選定 (重要ロジック):

フォルダ内の全ファイルをリスト化。

構造計算書: ファイル名に「構造計算書」を含むPDFを抽出。「【補正】」>「【修正】」>「通常」の優先順位で最強の1ファイルを選定。

指摘回答書: ファイル名に「指摘回答書」を含むPDFがあれば、最新のものを1つ選定。

マルチモーダルAI解析:

選定された「構造計算書」と「指摘回答書（あれば）」の2ファイルを同時に Gemini 2.5 Pro に渡す。

データ保存:

解析結果（JSON）を Firestore の projects コレクションに保存（ドキュメントID = 計算書のファイルID）。

4.2. 構造計算データ 検索カテゴリ一覧
1. 建物基本スペック
構造種別

木造（在来軸組）

木造（限界耐力計算）

木造（枠組壁）

鉄骨造

RC造（壁式）

RC造（ラーメン）

補強CB造

ボックスカルバート

混構造

テント

膜構造(TM整理中)

擁壁

耐震診断

工作物

SRC造

その他構造

用途

戸建住宅

共同住宅

長屋

店舗

事務所

倉庫

工場

車庫・カーポート

階数

平屋

2階建て

3階建て

4階建て以上

地下階あり

延床面積

〜100㎡

101〜300㎡

301〜500㎡

501〜1000㎡

1001㎡〜

2. 法規・計算ルート・性能
構造計算ルート

仕様規定のみ（壁量計算・N値計算など）

ルート1（許容応力度計算）

ルート2（許容応力度等計算）

ルート3（保有水平耐力計算）

限界耐力計算

適合性判定

適判物件（要判定）

不要

耐火性能要件

耐火建築物

準耐火建築物（ロ-1：燃えしろ設計・現し）

準耐火建築物（ロ-2：被覆・ボード張り）

準耐火建築物（イ準耐：1時間準耐火など）

省令準耐火構造

その他（法22条区域・指定なし区域）

性能表示・等級

長期優良住宅

耐震等級2

耐震等級3

積雪荷重の割増（多雪区域の等級取得）

3. 構造技術・工法（エレメント）
基礎形式

直接基礎（べた基礎）

直接基礎（布基礎）

直接基礎（独立基礎）

地盤改良あり（柱状・表層・鋼管）

杭基礎（既製杭・場所打ち杭）

水平力抵抗要素（耐震要素）

筋かい耐力壁

面材耐力壁（構造用合板・OSB・モイス・ダイライト等）

ラーメン構造（S造・RC造・門型フレーム等）

制震ダンパー

床・屋根構面

剛床（合板直張り）

火打ち構面

トラス構造

特徴的な設計・技術

大スパン・大空間（梁せいが大きい）

大開口（耐力壁が少ない）

オーバーハング・片持ち

スキップフロア

吹抜け

伝統構法

混構造（立面的・平面的）

4. プロジェクト条件・環境
多雪地域

指定なし

垂直積雪量 1m未満

垂直積雪量 1m以上（多雪補正あり）

風圧力・地表面粗度

基準風速 Vo=34m/s〜

地表面粗度区分 Ⅱ（海岸・平野部）

地表面粗度区分 Ⅲ（市街地）

地盤条件

良好

軟弱（液状化検討あり）

防火地域指定

防火地域

準防火地域

法22条区域

5. 管理・ツール情報
使用ソフト

KIZUKURI

HOUSE-ST1

SS7 / SS3

BUILD.一貫

その他（任意解析ソフト等）

取引先

（キーワード検索：工務店名、設計事務所名）

審査機関

（キーワード検索：ビューローベリタス、ERI、udi、確認サービス等）

4.3. AIプロンプトの仕様 (Vertex AI)
モデル: gemini-2.5-pro (us-central1)

設定: temperature = 0.0 (事実のみを抽出、創造性排除)

抽出項目:

建物スペック（構造種別、階数、面積など）

法規・性能（ルート、適判、耐震等級など）

技術・工法（基礎、耐力壁、スキップフロア等の特徴）

審査機関の特定: 指摘回答書のフッターや担当者メールアドレス（例: @udi-co.jp）から審査機関名を推測して抽出。

5. 認証・シークレット情報 (GCP Secret Manager)
以下のキーで登録済み。

MS_CLIENT_ID

MS_TENANT_ID

MS_CLIENT_SECRET

6. 実行コマンド
VS Codeターミナルで以下を実行。

Bash

# 仮想環境推奨 (任意)
# 認証がまだの場合
gcloud auth application-default login

# 実行
python batch_processor_v3.py
7. 次のステップ (To-Do)
batch_processor_v3.py の動作確認（ローカル実行）。

エラーハンドリングの強化（APIレートリミット対応など）。

コードのモジュール化（Cloud Run functions へのデプロイ準備）。

定期実行（Cloud Scheduler + Cloud Run Job）の構成検討。

■ Vercelホスティングに関する重要な補足
「検索画面（フロントエンド）」 は Vercel でのホスティングが最適ですが、今回作成している 「データ処理（バッチ）」 については以下の点にご注意ください。

検索画面 (UI): Vercel (Next.jsなど) が最適です。 高速で快適な検索サイトが作れます。

データ処理 (Python): Vercel Functions は不向き です。

理由: Vercelの関数には実行時間制限（通常10秒〜60秒）があり、AI解析や1万件の処理を行うとタイムアウトで強制終了してしまいます。

解決策: バッチ処理（batch_processor_v3.py）は、引き続き ローカル実行 または GCP (Cloud Run Jobs) で動かし、データの保存先である Firestore を介して、Vercelの画面と連携する構成がベストプラクティスです。